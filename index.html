<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>App Entregas - Modo Teste</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LEAFLET CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
:root {
  --azul: #1976d2;
  --verde: #2e7d32;
  --laranja: #f57c00;
  --cinza: #f2f2f2;
  --vermelho: #d32f2f;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--cinza);
}

header {
  background: var(--azul);
  color: white;
  padding: 16px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  position: sticky;
  top: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#saldo {
  font-weight: normal;
  font-size: 16px;
}

#map {
  width: 100%;
  height: 300px;
  margin: 10px 0;
  border-radius: 10px;
}

ul {
  list-style: none;
  padding: 10px;
}

li {
  background: white;
  padding: 14px;
  margin-bottom: 12px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
}

.status {
  font-weight: bold;
  margin-bottom: 6px;
}

.status.disponivel { color: var(--verde); }
.status.aceita { color: var(--laranja); }
.status.concluida { color: gray; }
.status.cancelada { color: var(--vermelho); }

.tempo, .valor, .distancia, .estimativa {
  font-size: 14px;
  color: #555;
}

button.acao {
  margin-top: 8px;
  background: var(--laranja);
  color: white;
  border: none;
  padding: 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

#btnDisponivel {
  width: 90%;
  margin: 10px auto;
  display: block;
  padding: 14px;
  background: var(--verde);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}

/* CHAT */
#chat-container {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 300px;
  height: 400px;
  background:white;
  border:1px solid #ccc;
  border-radius:10px;
  display:flex;
  flex-direction:column;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);
  z-index: 999;
}

#chat-header {
  background: var(--azul);
  color:white;
  padding:10px;
  font-weight:bold;
  border-top-left-radius:10px;
  border-top-right-radius:10px;
}

#chat-messages {
  flex:1;
  padding:10px;
  overflow-y:auto;
}

#chat-input {
  flex:1;
  padding:8px;
  border:none;
  border-radius:0;
}

#chat-send {
  background: var(--azul);
  color:white;
  border:none;
  padding:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  ðŸš´ Entregador Online
  <div id="saldo">Saldo: R$ 0,00</div>
</header>

<button id="btnDisponivel">Ficar IndisponÃ­vel</button>

<div id="map"></div>

<ul id="lista"></ul>

<!-- CHAT -->
<div id="chat-container">
  <div id="chat-header">Suporte Cliente</div>
  <div id="chat-messages"></div>
  <div style="display:flex;border-top:1px solid #ccc;">
    <input id="chat-input" placeholder="Digite uma mensagem...">
    <button id="chat-send">Enviar</button>
  </div>
</div>

<!-- LEAFLET JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
// MAPA
let map = L.map('map').setView([-23.55, -46.63], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let entregadorMarker = L.marker([-23.55, -46.63]).addTo(map).bindPopup("VocÃª (entregador)").openPopup();
let rotaControl = null;

let saldo = 0;
let corridas = [];
let disponivel = true;

// BOTAO DISPONIVEL/INDISPONIVEL
const btnDisponivel = document.getElementById('btnDisponivel');
btnDisponivel.addEventListener('click', () => {
  disponivel = !disponivel;
  if(disponivel) {
    btnDisponivel.innerText = "Ficar IndisponÃ­vel";
    btnDisponivel.style.backgroundColor = "#2e7d32";
  } else {
    btnDisponivel.innerText = "Ficar DisponÃ­vel";
    btnDisponivel.style.backgroundColor = "#d32f2f";
    if(rotaControl) { rotaControl.remove(); rotaControl = null; }
  }
  atualizarLista();
});

// TEMPO
function tempoUso(ms) {
  let seg = Math.floor(ms/1000);
  return `${Math.floor(seg/60)}m ${seg%60}s`;
}

// CRIAR CORRIDA ALEATORIA
function criarCorrida() {
  if(!disponivel) return;

  const origem = [-23.55 + Math.random()/100, -46.63 + Math.random()/100];
  const destino = [-23.56 + Math.random()/100, -46.64 + Math.random()/100];
  const valor = (Math.random()*15 + 5).toFixed(2);
  const criado = Date.now();

  const pontoColeta = L.latLng(origem[0], origem[1]);
  const pontoEntrega = L.latLng(destino[0], destino[1]);
  const entregadorPos = entregadorMarker.getLatLng();

  const distanciaColeta = (entregadorPos.distanceTo(pontoColeta)/1000).toFixed(2);
  const distanciaEntrega = (pontoColeta.distanceTo(pontoEntrega)/1000).toFixed(2);
  const estimativa = (distanciaColeta+distanciaEntrega)*3 + 5; // minutos aproximado

  const corrida = {origem, destino, valor, criado, status:'disponivel', distanciaColeta, distanciaEntrega, estimativa: Math.round(estimativa)};
  corridas.unshift(corrida);
  atualizarLista();
}

// ATUALIZAR LISTA
function atualizarLista() {
  const lista = document.getElementById('lista');
  lista.innerHTML = '';
  corridas.forEach((c, idx) => {
    let botao = '';
    if(c.status==='disponivel' && disponivel) {
      botao = `<button class="acao" onclick="aceitarCorrida(${idx})">Aceitar</button>`;
    } else if(c.status==='aceita') {
      botao = `<button class="acao" onclick="cancelarCorrida(${idx})" style="background-color:#d32f2f">Cancelar</button>`;
    }
    lista.innerHTML += `
      <li>
        <div class="status ${c.status}">Status: ${c.status}</div>
        <div class="valor">Valor: R$ ${c.valor}</div>
        <div class="distancia">Km atÃ© coleta: ${c.distanciaColeta}</div>
        <div class="distancia">Km de entrega: ${c.distanciaEntrega}</div>
        <div class="estimativa">Tempo estimado: ${c.estimativa} min</div>
        <div class="tempo">Tempo no app: ${tempoUso(Date.now()-c.criado)}</div>
        ${botao}
      </li>
    `;
  });
}

// ACEITAR CORRIDA
function aceitarCorrida(idx) {
  if(!disponivel) return alert("VocÃª estÃ¡ indisponÃ­vel!");

  const c = corridas[idx];
  c.status = 'aceita';
  atualizarLista();

  if(rotaControl) rotaControl.remove();
  rotaControl = L.Routing.control({
    waypoints: [
      L.latLng(entregadorMarker.getLatLng().lat, entregadorMarker.getLatLng().lng),
      L.latLng(c.destino[0], c.destino[1])
    ],
    routeWhileDragging: true
  }).addTo(map);

  animarEntrega(entregadorMarker.getLatLng(), c.destino, idx, parseFloat(c.valor));
}

// CANCELAR CORRIDA
function cancelarCorrida(idx) {
  const c = corridas[idx];
  if(c.status==='aceita') {
    c.status = 'cancelada';
    atualizarLista();
    if(rotaControl) { rotaControl.remove(); rotaControl = null; }
  }
}

// ANIMACAO ENTREGADOR
function animarEntrega(origemLatLng, destinoLatLng, idx, valor) {
  let passo = 0;
  const passos = 100;
  const deltaLat = (destinoLatLng[0]-origemLatLng.lat)/passos;
  const deltaLng = (destinoLatLng[1]-origemLatLng.lng)/passos;

  const anim = setInterval(()=>{
    if(!disponivel) { clearInterval(anim); return; }
    passo++;
    const novaLat = entregadorMarker.getLatLng().lat + deltaLat;
    const novaLng = entregadorMarker.getLatLng().lng + deltaLng;
    entregadorMarker.setLatLng([novaLat, novaLng]);
    map.setView([novaLat, novaLng]);

    if(passo>=passos) {
      clearInterval(anim);
      const c = corridas[idx];
      if(c.status==='aceita') {
        c.status = 'concluida';
        saldo += valor;
        document.getElementById('saldo').innerText = `Saldo: R$ ${saldo.toFixed(2)}`;
        if(rotaControl) { rotaControl.remove(); rotaControl = null; }
        atualizarLista();
      }
    }
  }, 100);
}

// GERAR CORRIDAS AUTOMATICAS
setInterval(criarCorrida, 5000);
for(let i=0;i<3;i++) criarCorrida();

// ===================== CHAT =====================
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');

chatSend.addEventListener('click', enviarMensagem);
chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') enviarMensagem(); });

function enviarMensagem(){
  const msg = chatInput.value.trim();
  if(!msg) return;
  adicionarMensagem('VocÃª', msg);
  chatInput.value = '';
  setTimeout(()=>{ adicionarMensagem('Cliente', respostasFake()); }, 1000);
}

function adicionarMensagem(remetente, msg){
  const div = document.createElement('div');
  div.style.marginBottom = '6px';
  div.innerHTML = `<b>${remetente}:</b> ${msg}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function respostasFake(){
  const respostas = [
    'Obrigado, estou aguardando!',
    'Pode me informar o tempo estimado?',
    'Tudo certo, obrigado!',
    'Ok, entendi.',
    'Estou na porta, obrigado!'
  ];
  return respostas[Math.floor(Math.random()*respostas.length)];
}
</script>

</body>
</html>
