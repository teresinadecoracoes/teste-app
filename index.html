<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>App Entregas Ultra Realista</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<style>
:root {
  --azul: #1976d2;
  --verde: #2e7d32;
  --laranja: #f57c00;
  --cinza: #f2f2f2;
  --vermelho: #d32f2f;
}

body { margin:0; font-family:Arial, sans-serif; background: var(--cinza); }
header { background: var(--azul); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; font-weight:bold; position:sticky; top:0; }
#saldo { font-weight: normal; font-size:16px; }
#map { width:100%; height:300px; margin:10px 0; border-radius:10px; }
ul { list-style:none; padding:10px; }
li { background:white; padding:14px; margin-bottom:12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); display:flex; flex-direction:column; }
.status { font-weight:bold; margin-bottom:6px; }
.status.disponivel { color: var(--verde); }
.status.aceita { color: var(--laranja); }
.status.concluida { color: gray; }
.status.cancelada { color: var(--vermelho); }
.tempo, .valor, .distancia, .estimativa, .codigo { font-size:14px; color:#555; }
button.acao { margin-top:8px; background:var(--laranja); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; }
#btnDisponivel { width:90%; margin:10px auto; display:block; padding:14px; background: var(--verde); color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer; }

#chat-container { position: fixed; bottom: 0; right:0; width:300px; height:400px; background:white; border:1px solid #ccc; border-radius:10px; display:flex; flex-direction:column; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:999; }
#chat-header { background: var(--azul); color:white; padding:10px; font-weight:bold; border-top-left-radius:10px; border-top-right-radius:10px; }
#chat-messages { flex:1; padding:10px; overflow-y:auto; }
#chat-input { flex:1; padding:8px; border:none; }
#chat-send { background: var(--azul); color:white; border:none; padding:8px; cursor:pointer; }

input.codigo-coleta { margin-top:6px; padding:6px; border-radius:4px; border:1px solid #ccc; }
button.confirmar { background:var(--verde); color:white; border:none; padding:8px; border-radius:4px; margin-top:6px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<header>
  üö¥ Entregador Online
  <div id="saldo">Saldo: R$ 0,00</div>
</header>

<button id="btnDisponivel">Ficar Indispon√≠vel</button>
<div id="map"></div>
<ul id="lista"></ul>

<!-- CHAT -->
<div id="chat-container">
  <div id="chat-header">Suporte Cliente</div>
  <div id="chat-messages"></div>
  <div style="display:flex;border-top:1px solid #ccc;">
    <input id="chat-input" placeholder="Digite uma mensagem...">
    <button id="chat-send">Enviar</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let map = L.map('map').setView([-23.55,-46.63],14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let entregadorMarker = L.marker([-23.55,-46.63]).addTo(map).bindPopup("Voc√™ (entregador)").openPopup();
let rotaControl = null;
let saldo = 0;
let corridas = [];
let disponivel = true;

const btnDisponivel = document.getElementById('btnDisponivel');
btnDisponivel.addEventListener('click', ()=>{
  disponivel = !disponivel;
  if(disponivel){ btnDisponivel.innerText="Ficar Indispon√≠vel"; btnDisponivel.style.backgroundColor="#2e7d32"; } 
  else { btnDisponivel.innerText="Ficar Dispon√≠vel"; btnDisponivel.style.backgroundColor="#d32f2f"; if(rotaControl) {rotaControl.remove(); rotaControl=null;} }
  atualizarLista();
});

// Pegando geolocaliza√ß√£o real
navigator.geolocation.getCurrentPosition(pos=>{
  entregadorMarker.setLatLng([pos.coords.latitude,pos.coords.longitude]);
  map.setView([pos.coords.latitude,pos.coords.longitude],14);
});

// Helper
function gerarCodigo(tipo){ return tipo+Math.floor(Math.random()*9000+1000); }
function tempoUso(ms){ let seg=Math.floor(ms/1000); return `${Math.floor(seg/60)}m ${seg%60}s`; }

// Criar corrida pr√≥xima do entregador
function criarCorrida(){
  if(!disponivel) return;
  const pos = entregadorMarker.getLatLng();
  const origem = [pos.lat + (Math.random()-0.5)/100, pos.lng + (Math.random()-0.5)/100];
  const destino = [pos.lat + (Math.random()-0.5)/100, pos.lng + (Math.random()-0.5)/100];
  const valor = (Math.random()*15+5).toFixed(2);
  const criado = Date.now();
  const codigoColeta = gerarCodigo('COLETA');
  const codigoEntrega = gerarCodigo('ENTREGA');

  const distanciaColeta = (L.latLng(pos.lat,pos.lng).distanceTo(L.latLng(origem[0],origem[1]))/1000).toFixed(2);
  const distanciaEntrega = (L.latLng(origem[0],origem[1]).distanceTo(L.latLng(destino[0],destino[1]))/1000).toFixed(2);
  const estimativa = Math.round((parseFloat(distanciaColeta)+parseFloat(distanciaEntrega))*3+5);

  corridas.unshift({origem,destino,valor,criado,status:'disponivel',distanciaColeta,distanciaEntrega,estimativa,codigoColeta,codigoEntrega,coletaConfirmada:false});
  atualizarLista();
  tocarNotificacao();
}

// Atualizar lista
function atualizarLista(){
  const lista = document.getElementById('lista');
  lista.innerHTML='';
  corridas.forEach((c,idx)=>{
    let botao=''; let codigoDisplay='';
    if(c.status==='disponivel' && disponivel) botao=`<button class="acao" onclick="aceitarCorrida(${idx})">Aceitar</button>`;
    else if(c.status==='aceita' && !c.coletaConfirmada){
      codigoDisplay=`<div class="codigo"><b>C√≥digo Coleta:</b> ${c.codigoColeta}</div>
      <input type="text" placeholder="Digite o c√≥digo" class="codigo-coleta" id="input${idx}">
      <button class="confirmar" onclick="confirmarColeta(${idx})">Confirmar coleta</button>`;
    }
    else if(c.status==='aceita' && c.coletaConfirmada){ 
      botao=`<button class="acao" onclick="cancelarCorrida(${idx})" style="background-color:#d32f2f">Cancelar</button>`;
      codigoDisplay=`<div class="codigo"><b>Coleta confirmada</b></div>`;
    }
    lista.innerHTML+=`
      <li>
        <div class="status ${c.status}">Status: ${c.status}</div>
        <div class="valor">Valor: R$ ${c.valor}</div>
        <div class="distancia">Km at√© coleta: ${c.distanciaColeta}</div>
        <div class="distancia">Km de entrega: ${c.distanciaEntrega}</div>
        <div class="estimativa">Tempo estimado: ${c.estimativa} min</div>
        ${codigoDisplay}
        <div class="tempo">Tempo no app: ${tempoUso(Date.now()-c.criado)}</div>
        ${botao}
      </li>
    `;
  });
}

// Confirmar coleta
function confirmarColeta(idx){
  const c=corridas[idx];
  const input=document.getElementById('input'+idx);
  if(input.value.trim()===c.codigoColeta){
    c.coletaConfirmada=true;
    atualizarLista();
    // envia c√≥digo de entrega para o cliente
    adicionarMensagem('Cliente',`C√≥digo de entrega: ${c.codigoEntrega}`);
    animarRotaReal(idx);
  } else {
    alert("C√≥digo incorreto!");
  }
}

// Aceitar corrida
function aceitarCorrida(idx){
  if(!disponivel) return alert("Voc√™ est√° indispon√≠vel!");
  corridas[idx].status='aceita'; atualizarLista();
}

// Cancelar
function cancelarCorrida(idx){ const c=corridas[idx]; if(c.status==='aceita'){ c.status='cancelada'; atualizarLista(); if(rotaControl){rotaControl.remove(); rotaControl=null;} }}

// Anima√ß√£o seguindo rota real
function animarRotaReal(idx){
  const c = corridas[idx];
  if(rotaControl) rotaControl.remove();
  rotaControl = L.Routing.control({ waypoints:[entregadorMarker.getLatLng(),L.latLng(c.destino[0],c.destino[1])], routeWhileDragging:true }).addTo(map);

  const control = rotaControl.getPlan();
  const line = control._line._latlngs;
  let i=0;
  const anim = setInterval(()=>{
    if(!disponivel){ clearInterval(anim); return; }
    if(i>=line.length){ clearInterval(anim); finalizarCorrida(idx); return; }
    entregadorMarker.setLatLng(line[i]);
    const distColeta = L.latLng(line[i]).distanceTo(L.latLng(c.origem[0],c.origem[1]))/1000;
    const distEntrega = L.latLng(line[i]).distanceTo(L.latLng(c.destino[0],c.destino[1]))/1000;
    c.distanciaColeta = distColeta.toFixed(2);
    c.distanciaEntrega = distEntrega.toFixed(2);
    atualizarLista();
    i++;
  },200);
}

// Finalizar corrida
function finalizarCorrida(idx){ const c=corridas[idx]; c.status='concluida'; saldo+=parseFloat(c.valor); document.getElementById('saldo').innerText=`Saldo: R$ ${saldo.toFixed(2)}`; atualizarLista(); if(rotaControl){rotaControl.remove(); rotaControl=null;}}

// Notifica√ß√£o sonora
function tocarNotificacao(){ const audio=new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'); audio.play(); }

// ================= CHAT =================
const chatMessages=document.getElementById('chat-messages');
const chatInput=document.getElementById('chat-input');
const chatSend=document.getElementById('chat-send');
chatSend.addEventListener('click',enviarMensagem);
chatInput.addEventListener('keypress',(e)=>{if(e.key==='Enter') enviarMensagem();});
function enviarMensagem(){ const msg=chatInput.value.trim(); if(!msg) return; adicionarMensagem('Voc√™',msg); chatInput.value=''; setTimeout(()=>{ adicionarMensagem('Cliente',respostasFake()); },1000);}
function adicionarMensagem(remetente,msg){ const div=document.createElement('div'); div.style.marginBottom='6px'; div.innerHTML=`<b>${remetente}:</b> ${msg}`; chatMessages.appendChild(div); chatMessages.scrollTop=chatMessages.scrollHeight;}
function respostasFake(){ const r=['Obrigado, estou aguardando!','Pode me informar o tempo estimado?','Tudo certo, obrigado!','Ok, entendi.','Estou na porta, obrigado!']; return r[Math.floor(Math.random()*r.length)];}

// Corridas autom√°ticas
setInterval(criarCorrida,5000);
for(let i=0;i<3;i++) criarCorrida();
</script>

</body>
</html>
